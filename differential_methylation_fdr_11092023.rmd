---
title: "differential methylation"
author: "Anderson Butler"
date: "2023-04-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999) 
```

```{r}
library(dplyr)
library(minfi)
# load data
# df_normalized = readRDS("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_data/20221020_dnamstability_normalizedBetas_raw_abutler.Rds")
# df_normalized$X205832330169_R03C01 = NULL #drop outlier

library(readr)
SampleAnnotation = readRDS("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_data/20221020_dnamstability_SampleAnnotation_for_ibishof.Rds")
SampleAnnotation$grouping_variable = as.factor(SampleAnnotation$grouping_variable)
# 
# # # Remove rows containing more than 10% NAs and median impute
# remove_na_median_impute <- function(dataframe){
#   # Remove rows containing more than 10% NAs
#   dataframe <- dataframe[rowSums(is.na(dataframe))/ncol(dataframe) < 0.1,]
#   # Median impute remaining rows
#   for (i in 1:nrow(dataframe)) {
#     dataframe[i, which(is.na(dataframe[i,]))] <- median(as.numeric(dataframe[i,]),na.rm=TRUE)
#   }
#   class(as.numeric(dataframe[i,]))
#   return(dataframe)
# }
# df_normalized = remove_na_median_impute(df_normalized)

# remove_na_median_impute <- function(dataframe){
#   # Remove rows containing more than 10% NAs
#   dataframe <- dataframe[rowSums(is.na(dataframe))/ncol(dataframe) < 0.1,]
#   # Median impute remaining rows
#   for (i in 1:nrow(dataframe)) {
#     dataframe[i, which(is.na(dataframe[i,]))] <- median(as.numeric(dataframe[i,]),na.rm=TRUE)
#   }
#   class(as.numeric(dataframe[i,]))
#   return(dataframe)
# }
# df_normalized = remove_na_median_impute(df_normalized)

df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")
```

```{r}

# load beta values
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL
df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

compiled_beta_values = readRDS("compiled_beta_values.Rds")
ComBatFI_seq_betas = compiled_beta_values[[2]]
rm(compiled_beta_values)
```



# some plotting functions and a priori calculations for stdev ratios
```{r}

# used a couple of times to aggregate dataframes by common rownames
rename_cols_and_aggregate = function(list_of_dfs){
  for (i in 1:length(list_of_dfs)){
    old_colnames = colnames(list_of_dfs[[i]])
    add_to_colname = names(list_of_dfs[i])
    new_colnames = paste0(old_colnames,"_",add_to_colname)
    colnames(list_of_dfs[[i]]) = new_colnames
  }
  for (i in 1:length(list_of_dfs)){
   if (i == 1){
     df_cbind = list_of_dfs[[i]]
   }
    else {df_cbind = merge(df_cbind,list_of_dfs[[i]],by = 'row.names')
    rownames(df_cbind) = df_cbind$Row.names
    df_cbind$Row.names = NULL}
  }
  return(df_cbind)
}

# plot_p_values

plot_p_values = function(list_of_dfs,dmp_cpgs){
  
  aggregated_dfs = rename_cols_and_aggregate(list_of_dfs)
  
  if (length(dmp_cpgs) >= 1000){
  aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    slice_sample(n = 1000) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.02) +
            ylab("p-values")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)
  }
  
  else {aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.02) +
            ylab("p-values")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)}
}

# list_of_dfs = list(raw = dmp_unnormalized_categorical,
#            sesame = dmp_sesame_categorical,
#            combat = dmp_normalized_combat1_categorical,
#            combatFI = dmp_ComBatSeqFI)
# 
upset_df_to_plotted_p_values = function(list_of_dfs,upset_df){
  # comparisons:
  
  
  
  
  
  library(stringr)
  
  ## only unnormalized:
  
  dmps_raw_only = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
  plot_p_values(list_of_dfs,dmps_raw_only)

  ## only sesame:
  
  dmps_sesame_only = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_sesame_only)

  
  ## only after combat
  
  dmps_after_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combat)

  
## only after combatFI
  
  dmps_after_combatFI = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combatFI)

  
## only after sesame
  
  dmps_after_sesame_including_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_sesame_including_combat)

  
## everything
  
  dmps_everything = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_everything)

  
}



betas_list = list(raw = df_unnormalized,
                  sesame = df_normalized,
                  combatBetas = df_normalized_with_combat,
                  combatFI = ComBatFI_seq_betas)


betas_list_merged = rename_cols_and_aggregate(betas_list)

# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)
betas_list = list(raw = df_unnormalized,
                  sesame = df_normalized,
                  combatBetas = df_normalized_with_combat,
                  combatFI = ComBatFI_seq_betas)


betas_list_merged = rename_cols_and_aggregate(betas_list)



# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL)

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject b
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject d
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject a
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_a = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject c
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_c = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))





stdevA_to_stdevAll = stdev_a / (stdev_all+0.0001)
rownames(stdevA_to_stdevAll)= rownames(betas_list_merged)

stdevB_to_stdevAll = stdev_b / (stdev_all+0.0001)
rownames(stdevB_to_stdevAll)= rownames(betas_list_merged)

stdevC_to_stdevAll = stdev_c / (stdev_all+0.0001)
rownames(stdevC_to_stdevAll)= rownames(betas_list_merged)

stdevD_to_stdevAll = stdev_d / (stdev_all+0.0001)
rownames(stdevD_to_stdevAll) = rownames(betas_list_merged)


```


# outlier boxplot
```{r}
stdevRatio_raw = data.frame(a = stdevA_to_stdevAll$raw_stdev,
                           b = stdevB_to_stdevAll$raw_stdev,
                           c = stdevC_to_stdevAll$raw_stdev,
                           d = stdevD_to_stdevAll$raw_stdev)
stdevRatio_sesame = data.frame(a = stdevA_to_stdevAll$sesame_stdev,
                           b = stdevB_to_stdevAll$sesame_stdev,
                           c = stdevC_to_stdevAll$sesame_stdev,
                           d = stdevD_to_stdevAll$sesame_stdev)
stdevRatio_combatBeta = data.frame(a = stdevA_to_stdevAll$combatBeta_stdev,
                           b = stdevB_to_stdevAll$combatBeta_stdev,
                           c = stdevC_to_stdevAll$combatBeta_stdev,
                           d = stdevD_to_stdevAll$combatBeta_stdev)
stdevRatio_combatFI = data.frame(a = stdevA_to_stdevAll$combatFI_stdev,
                           b = stdevB_to_stdevAll$combatFI_stdev,
                           c = stdevC_to_stdevAll$combatFI_stdev,
                           d = stdevD_to_stdevAll$combatFI_stdev)
averages_stdev_ratio = data.frame(raw = apply(stdevRatio_raw,1,mean),
                                  sesame = apply(stdevRatio_sesame,1,mean),
                                  combatBeta = apply(stdevRatio_combatBeta,1,mean),
                                  combatFI = apply(stdevRatio_combatFI,1,mean)
                                  )
rownames(averages_stdev_ratio) = rownames(stdevB_to_stdevAll)

averages_stdev_ratio = reshape2::melt(averages_stdev_ratio)
library(ggplot2)
graph_global_stdev_ratios <- ggplot(averages_stdev_ratio, aes(x = variable, y = value)) +
  geom_boxplot(notch = FALSE, outlier.size = 0.1, linewidth=0.25) +
  theme_bw() + 
  ggtitle("stdev ratios across all samples")
graph_global_stdev_ratios
```

edit the above to be a function that can be used on a set of samples:

bookmark1
```{r}
make_stdevRatio_boxplots = function(list_of_samples){
# needs these dataframes in the env
betas_list = list(raw = df_unnormalized,
                sesame = df_normalized,
                combatBetas = df_normalized_with_combat,
                combatFI = ComBatFI_seq_betas)
# also this function
betas_list_merged = rename_cols_and_aggregate(betas_list)


# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)






# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject b
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject d
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
  select(any_of(list_of_samples))

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# # for subject a
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_a = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# # for subject c
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_c = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# 



# stdevA_to_stdevAll = stdev_a / (stdev_all+0.0001)
# rownames(stdevA_to_stdevAll)= rownames(betas_list_merged)

stdevB_to_stdevAll = stdev_b / (stdev_all+0.0001)
rownames(stdevB_to_stdevAll)= rownames(betas_list_merged)

# stdevC_to_stdevAll = stdev_c / (stdev_all+0.0001)
# rownames(stdevC_to_stdevAll)= rownames(betas_list_merged)

stdevD_to_stdevAll = stdev_d / (stdev_all+0.0001)
rownames(stdevD_to_stdevAll) = rownames(betas_list_merged)


stdevRatio_raw = data.frame(#a = stdevA_to_stdevAll$raw_stdev,
                           b = stdevB_to_stdevAll$raw_stdev,
                           #c = stdevC_to_stdevAll$raw_stdev,
                           d = stdevD_to_stdevAll$raw_stdev)
stdevRatio_sesame = data.frame(#a = stdevA_to_stdevAll$sesame_stdev,
                           b = stdevB_to_stdevAll$sesame_stdev,
                           #c = stdevC_to_stdevAll$sesame_stdev,
                           d = stdevD_to_stdevAll$sesame_stdev)
stdevRatio_combatBeta = data.frame(#a = stdevA_to_stdevAll$combatBeta_stdev,
                           b = stdevB_to_stdevAll$combatBeta_stdev,
                           #c = stdevC_to_stdevAll$combatBeta_stdev,
                           d = stdevD_to_stdevAll$combatBeta_stdev)
stdevRatio_combatFI = data.frame(#a = stdevA_to_stdevAll$combatFI_stdev,
                           b = stdevB_to_stdevAll$combatFI_stdev,
                           #c = stdevC_to_stdevAll$combatFI_stdev,
                           d = stdevD_to_stdevAll$combatFI_stdev)
averages_stdev_ratio = data.frame(raw = apply(stdevRatio_raw,1,mean),
                                  sesame = apply(stdevRatio_sesame,1,mean),
                                  combatBeta = apply(stdevRatio_combatBeta,1,mean),
                                  combatFI = apply(stdevRatio_combatFI,1,mean)
                                  )
rownames(averages_stdev_ratio) = rownames(stdevB_to_stdevAll)

averages_stdev_ratio = reshape2::melt(averages_stdev_ratio)

graph_global_stdev_ratios <- ggplot(averages_stdev_ratio, aes(x = variable, y = value)) +
  geom_boxplot(notch = FALSE) +
  theme_bw() + 
  ggtitle("stdev ratios across all samples")
graph_global_stdev_ratios
}
```


```{r}
betas_numbered = df_normalized %>%
  dplyr::select(SampleAnnotation$XChipID[SampleAnnotation$pooled==FALSE])
dat = as.matrix(betas_numbered)
my_phenotype = SampleAnnotation$grouping_variable[SampleAnnotation$pooled==FALSE]
my_phenotype = droplevels(my_phenotype)
dmp_sesame = dmpFinder(dat, pheno = my_phenotype  , type = "continuous")
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")
```

```{r}
# df_unnormalized = readRDS("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_data/20221111_dnamstability_unnormalizedBetas_sesame_abutler.Rds")
# df_unnormalized$X205832330169_R03C01 = NULL #drop outlier
# 
# df_unnormalized = remove_na_median_impute(df_unnormalized)
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")
betas_numbered = df_unnormalized %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$pooled==FALSE])

dat = as.matrix(betas_numbered)
my_phenotype = SampleAnnotation$grouping_variable[SampleAnnotation$pooled==FALSE]
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized = dmpFinder(dat, pheno = my_phenotype  , type = "continuous")
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype, type = "categorical")
```

```{r}
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL
df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier




betas_numbered = df_normalized_with_combat %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$pooled==FALSE])

dat = as.matrix(betas_numbered)
my_phenotype = SampleAnnotation$grouping_variable[SampleAnnotation$pooled==FALSE]
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1 = dmpFinder(dat, pheno = my_phenotype  , type = "continuous")
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

```

Note: code below is for continuous dmpfinder and not used in the publication. Categorical is below.

```{r}
# library(ggplot2)
# # The code below will generate the graph:
# graph1 <- ggplot(dmp_sesame, aes(x = pval)) +
#   geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
#   theme_bw() + 
#   ylim(0,250000) + 
#   ggtitle("SeSAMe")
# graph1
# 
# graph2 <- ggplot(dmp_unnormalized, aes(x = pval)) +
#   geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
#   theme_bw() + 
#   ylim(0,250000) + 
#   ggtitle("Raw")
# graph2
# 
# graph3 <- ggplot(dmp_normalized_combat1, aes(x = pval)) +
#   geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
#   theme_bw() + 
#   ylim(0,250000) + 
#   ggtitle("SeSAMe + ComBat")
# graph3
# 
# library(patchwork)
# (graph2|graph1|graph3)

```

categorical plots
```{r}
library(ggplot2)
# The code below will generate the graph:
graph1 <- ggplot(dmp_sesame_categorical, aes(x = pval)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,250000) + 
  theme(text = element_text(size = 5))  +
  ggtitle("SeSAMe")
graph1

graph2 <- ggplot(dmp_unnormalized_categorical, aes(x = pval)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,250000) + 
  theme(text = element_text(size = 5))  +
  ggtitle("Raw")
graph2

graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = pval)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,250000) + 
  theme(text = element_text(size = 5))  +
  ggtitle("SeSAMe + ComBat")
graph3

library(patchwork)
(graph2|graph1|graph3)
# graph4 added below to make figS2
```

```{r}

```

```{r}
library(ggplot2)
# The code below will generate the graph:
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")


count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

#ggplotgui::ggplot_shiny(dmp_normalized_combat1_categorical)

graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  +
  scale_y_log10()
graph3


fig_differential_methylation_BH_pValues = (graph1 / graph2)/(graph3)
fig_differential_methylation_BH_pValues
```

```{r}
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BH_pValues.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (90/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues
dev.off()
###


```

# Detect false negatives

The idea here is that we might be able to use biological differences as a test to see how harshly ComBat is treating the data.

The way we'll do that is by comparing two subjects. First in a test where the data are confounded by chamber number, but have the same sample pool in each group and thus should have no true differences. And then second, we'll compare the same subjects when not confounded using the pooled samples.

```{r}
# load beta values
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

```

```{r}
# Load SampleAnnotation
library(readr)
SampleAnnotation = readRDS("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_data/20221020_dnamstability_SampleAnnotation_for_ibishof.Rds")
SampleAnnotation$grouping_variable = as.factor(SampleAnnotation$grouping_variable)

# Initialize variables
SampleAnnotation$grouping_FalseNegBioDifferences = rep("OOB",length(SampleAnnotation$ChIP_ID))
SampleAnnotation$grouping_FalseNegChamberDifferences = rep("OOB",length(SampleAnnotation$ChIP_ID))

# Set up grouping_FalseNegBioDifferences

for (i in 1:length(SampleAnnotation$ChIP_ID)){
  
  #group 1 = A's in pooled
  if (SampleAnnotation$subjectLetter[i] == "B" & SampleAnnotation$pooled[i]==TRUE){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "1"
  }
  
  #group 2 = D's in pooled
  if (SampleAnnotation$subjectLetter[i] == "D" & SampleAnnotation$pooled[i]==TRUE){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "2"
  }
  
  #group 3 = A's and D's in numbered, chambers 1-4
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==F & 
      SampleAnnotation$lane[i] %in% c("R01","R02","R03","R04")){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "3"
  }
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==F & 
      SampleAnnotation$lane[i] %in% c("R01","R02","R03","R04")){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "3"
  }
  
  #group 4 = A's and D's in numbered, chambers 5-8
    if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==F & 
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "4"
  }
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==F & 
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")){
    SampleAnnotation$grouping_FalseNegBioDifferences[i] = "4"
  }
}


```

## BP1-8 vs DP1-8

```{r}
# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$grouping_FalseNegBioDifferences == "1" | 
           SampleAnnotation$grouping_FalseNegBioDifferences == "2")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype, type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# ComBat_seq on FIs
compiled_beta_values = readRDS("compiled_beta_values.Rds")
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

```

### Plots

```{r}
library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3

# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_1 = (graph1 | graph2) / (graph3 + graph6)
  
fig_differential_methylation_BH_pValues_1 = fig_differential_methylation_BH_pValues_1 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP1-8 vs DP1-8') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))

fig_differential_methylation_BH_pValues_1


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(dmp_ComBatSeqFI,
                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df$variable = as.character(upset_df$variable)
upset_df = upset_df %>%
  filter(value < 0.05)

upset_df = upset_df %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_BP1to8vsDP1to8 = upset_df %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() +
    ggtitle("BP12345678 vs DP12345678")

upset_gg_BP1to8vsDP1to8

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_BP1to8vsDP1to8 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          order.by="freq",
                          text.scale = 0.5)
upset_BP1to8vsDP1to8







library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP1-8 vs DP1-8.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_1
dev.off()

```

## BP1-8 vs BN1-8

```{r}

# Set up grouping_FalsePosN8
SampleAnnotation$grouping_FalsePosN8 = rep("oob",length(SampleAnnotation$grouping_FalseNegBioDifferences))

for (i in 1:length(SampleAnnotation$ChIP_ID)){
  
  #group 1 = B's in pooled
  if (SampleAnnotation$subjectLetter[i] == "B" & SampleAnnotation$pooled[i]==TRUE){
    SampleAnnotation$grouping_FalsePosN8[i] = "1"
  }
  
  #group 2 = B's in numbered
  if (SampleAnnotation$subjectLetter[i] == "B" & SampleAnnotation$pooled[i]==FALSE){
    SampleAnnotation$grouping_FalsePosN8[i] = "2"
  }
  
  #group 3 = D's in pooled
  if (SampleAnnotation$subjectLetter[i] == "D" & SampleAnnotation$pooled[i]==TRUE){
    SampleAnnotation$grouping_FalsePosN8[i] = "3"
  }
  
  #group 4 = D's in numbered
  if (SampleAnnotation$subjectLetter[i] == "D" & SampleAnnotation$pooled[i]==FALSE){
    SampleAnnotation$grouping_FalsePosN8[i] = "4"
  }
}




# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$grouping_FalsePosN8 == "1" | 
           SampleAnnotation$grouping_FalsePosN8 == "2")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalsePosN8)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalsePosN8)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype, type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalsePosN8)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# ComBat_seq on FIs
compiled_beta_values = readRDS("compiled_beta_values.Rds")
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalsePosN8)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

```

### Plots

```{r}
library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3

# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_1 = (graph1 | graph2) / (graph3 + graph6)
  
fig_differential_methylation_BH_pValues_1 = fig_differential_methylation_BH_pValues_1 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP1-8 vs DP1-8') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))

fig_differential_methylation_BH_pValues_1


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(dmp_ComBatSeqFI,
                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df$variable = as.character(upset_df$variable)
upset_df = upset_df %>%
  filter(value < 0.05)

upset_df = upset_df %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_BP1to8vsBN1to8 = upset_df %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() +
    ggtitle("BP12345678 vs BN12345678")

upset_gg_BP1to8vsBN1to8

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP1-8 vs DP1-8.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_1
dev.off()

```



## BN1-4 & DN1-4 vs BN5-8 & DN5-8

```{r}
# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$grouping_FalseNegBioDifferences == "3" | 
           SampleAnnotation$grouping_FalseNegBioDifferences == "4")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$grouping_FalseNegBioDifferences)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

```

### Plots

```{r}
library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2_8v8 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "darkblue") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2_8v8

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1_8v8 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "darkblue") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1_8v8

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3_8v8 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "darkblue") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3_8v8

# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6_8v8 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "darkblue") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6_8v8

library(patchwork)
fig_differential_methylation_BH_pValues_2 = (graph1_8v8 | graph2_8v8) / (graph3_8v8 | graph6_8v8)
  
fig_differential_methylation_BH_pValues_2 = fig_differential_methylation_BH_pValues_2 + 
  plot_annotation(tag_levels = 'a',
                  title = '(BP1-4 & DP1-4) vs (BP5-8 & DP5-8)') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_2


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),
                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,
                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df$variable = as.character(upset_df$variable)
upset_df = upset_df %>%
  filter(value < 0.05)

upset_df = upset_df %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_BN1234andDN1234vsBN5678andDN5678 = upset_df %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "darkblue") +
    scale_x_upset() + 
  ggtitle("BN1234 & DN1234 vs BN5678 & DN5678")
upset_gg_BN1234andDN1234vsBN5678andDN5678

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_BN1234andDN1234vsBN5678andDN5678 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          order.by="freq",
                          text.scale = 0.5)
upset_BN1234andDN1234vsBN5678andDN5678


library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BN1234andDN1234vsBN5678andDN5678.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_2
dev.off()

```

## dvera ground truths:

### group assignment

```{r}
SampleAnnotation$dvera_groundTruth = rep("oob",length(SampleAnnotation$ChIP_ID))
SampleAnnotation$dvera_groundTruthForPlotting = rep("oob",length(SampleAnnotation$ChIP_ID))


# Set up dvera_groundTruth

for (i in 1:length(SampleAnnotation$ChIP_ID)){
  
  #group 5 = D's in numbered (1-4)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R01","R02","R03","R04")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "5"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv3"
  }
  
  #group 6 = D's in numbered (5-8)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "6"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv3"
  }
  
  #group 4 = B's in numbered (5-8)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "4"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv2"
  }
  
  #group 3 = B's in numbered (1-4)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R01","R02","R03","R04")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "3"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv2"
  }
  
  #group 1 = D's in pooled (2,4,5,6)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "1"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv1"
  }
  
  #group 2 = B's in pooled (2,4,5,6)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "2"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv1"
  }
  
  #group 7 = B's in pooled (1,3,7,8)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "7"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv4"
  }
  
  #group 8 = D's in pooled (1,3,7,8)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$dvera_groundTruth[i] = "8"
    SampleAnnotation$dvera_groundTruthForPlotting[i] = "dv4"
  }
  
}


```

### Plots 1v2 (BP2456 vs DP2456)

```{r}
# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$dvera_groundTruth == "1" | 
           SampleAnnotation$dvera_groundTruth == "2")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2_dv1 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2_dv1

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1_dv1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1_dv1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3_dv1 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3_dv1


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6_dv1 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6_dv1

library(patchwork)
fig_differential_methylation_BH_pValues_dv1 = (graph1_dv1 | graph2_dv1) / (graph3_dv1 | graph6_dv1)
  
fig_differential_methylation_BH_pValues_dv1 = fig_differential_methylation_BH_pValues_dv1 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP2456 vs DP2456') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))

fig_differential_methylation_BH_pValues_dv1


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_dv1 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_dv1$variable = as.character(upset_df_dv1$variable)
upset_df_dv1 = upset_df_dv1 %>%
  filter(value < 0.05)

upset_df_dv1 = upset_df_dv1 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_1v2_dv1 = upset_df_dv1 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() +
  ggtitle("BP2456 vs DP2456")
upset_gg_1v2_dv1

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_1v2 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          order.by="freq",
                          text.scale = 0.5)
upset_1v2

list_of_dfs_dv1 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP2456vsDP2456.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_dv1
dev.off()

```

### Plots 3v4 (BN1234 vs BN5678)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$dvera_groundTruth == "3" | 
           SampleAnnotation$dvera_groundTruth == "4")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")






# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2_dv2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2_dv2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1_dv2 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1_dv2

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3_dv2 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3_dv2


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6_dv2 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6_dv2

library(patchwork)
fig_differential_methylation_BH_pValues_dv2 = (graph1_dv2 | graph2_dv2) / (graph3_dv2 | graph6_dv2)
  
fig_differential_methylation_BH_pValues_dv2 = fig_differential_methylation_BH_pValues_dv2 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BN1234 vs BN5678') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_dv2



all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_dv2 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_dv2$variable = as.character(upset_df_dv2$variable)
upset_df_dv2 = upset_df_dv2 %>%
  filter(value < 0.05)

upset_df_dv2 = upset_df_dv2 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_3v4_dv2 = upset_df_dv2 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset()+
  ggtitle("BN1234 vs BN5678")
upset_gg_3v4_dv2

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_3v4 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          order.by="freq",
                          text.scale = 0.5)
upset_3v4

list_of_dfs_dv2 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BN1234vsBN5678.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_dv2
dev.off()


```

### Plots 5v6 (DN1234 vs DN5678)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$dvera_groundTruth == "5" | 
           SampleAnnotation$dvera_groundTruth == "6")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2_dv3 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2_dv3

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1_dv3 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1_dv3

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3_dv3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3_dv3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6_dv3 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6_dv3

library(patchwork)
fig_differential_methylation_BH_pValues_dv3 = (graph1_dv3 | graph2_dv3) / (graph3_dv3 | graph6_dv3)
  
fig_differential_methylation_BH_pValues_dv3 = fig_differential_methylation_BH_pValues_dv3 + 
  plot_annotation(tag_levels = 'a',
                  title = 'DN1234 vs DN5678') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_dv3


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_dv3 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_dv3$variable = as.character(upset_df_dv3$variable)
upset_df_dv3 = upset_df_dv3 %>%
  filter(value < 0.05)

upset_df_dv3 = upset_df_dv3 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_5v6_dv3 = upset_df_dv3 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("DN1234 vs DN5678")
upset_gg_5v6_dv3

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_5v6 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          order.by="freq",
                          text.scale = 0.5)
upset_5v6

list_of_dfs_dv3 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_DN1234vsDN5678.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_dv3
dev.off()


```

### Plots 7v8 (DP1378 vs BP1378)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$dvera_groundTruth == "7" | 
           SampleAnnotation$dvera_groundTruth == "8")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")



# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$dvera_groundTruth)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2_dv4 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2_dv4

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1_dv4 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1_dv4

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3_dv4 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3_dv4


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6_dv4 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6_dv4

library(patchwork)
fig_differential_methylation_BH_pValues_dv4 = (graph1_dv4 | graph2_dv4) / (graph3_dv4 | graph6_dv4)
  
fig_differential_methylation_BH_pValues_dv4 = fig_differential_methylation_BH_pValues_dv4 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP1378 vs DP1378') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_dv4

all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_dv4 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_dv4$variable = as.character(upset_df_dv4$variable)
upset_df_dv4 = upset_df_dv4 %>%
  filter(value < 0.05)

upset_df_dv4_for_venn = upset_df_dv4

upset_df_dv4 = upset_df_dv4 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_7v8_dv4 = upset_df_dv4 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("DP1378 vs BP1378")
upset_gg_7v8_dv4

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

upset_7v8 = UpSetR::upset(merged_df_onehot,
                          nsets = 6, 
                          nintersects = NA,
                          # intersections = list(list("dmp_unnormalized_categorical_padj"),
                          #                      list("dmp_sesame_categorical_padj"),
                          #                      list("dmp_normalized_combat1_categorical_padj"),
                          #                      list("dmp_unnormalized_categorical_padj",
                          #                           "dmp_sesame_categorical_padj"),
                          #                      list("dmp_normalized_combat1_categorical_padj",
                          #                           "dmp_ComBatFI_padj",
                          #                           "dmp_ComBatSeqFI_padj"))
                          order.by="freq",
                          text.scale = 0.5)
upset_7v8

list_of_dfs_dv4 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_DN1234vsDN5678.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_dv4
dev.off()


```




```{r}
format_ggupset = function(ggplot_object){
  ggplot_object + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          text = element_text(family = "Helvetica", size = 6),
          axis.text.y = element_text(size = 6),
          axis.title = element_text(size = 6)) + 
    theme_combmatrix(
      combmatrix.label.make_space = TRUE,
      combmatrix.label.width = NULL,
      combmatrix.label.height = NULL,
      combmatrix.label.extra_spacing = 3,
      combmatrix.label.total_extra_spacing = unit(10, "pt"),
      combmatrix.label.text = NULL,
      combmatrix.panel.margin = unit(c(1.5, 1.5), "pt"),
      combmatrix.panel.striped_background = TRUE,
      combmatrix.panel.striped_background.color.one = "white",
      combmatrix.panel.striped_background.color.two = "#F7F7F7",
      combmatrix.panel.point.size = 0.5,
      combmatrix.panel.line.size = 0.25,
      combmatrix.panel.point.color.fill = "black",
      combmatrix.panel.point.color.empty = "#E0E0E0")
}
```



```{r}
library(patchwork)
f_upset_gg_1v2_dv1 = format_ggupset(upset_gg_1v2_dv1)
f_upset_gg_3v4_dv2 = format_ggupset(upset_gg_3v4_dv2)
f_upset_gg_5v6_dv3 = format_ggupset(upset_gg_5v6_dv3)
f_upset_gg_7v8_dv4 = format_ggupset(upset_gg_7v8_dv4)



(f_upset_gg_1v2_dv1 + f_upset_gg_7v8_dv4) /
  (f_upset_gg_3v4_dv2 + f_upset_gg_5v6_dv3)


```







# abutler_testingGroundTruth

```{r}
SampleAnnotation$abutler_4v4 = rep("oob",length(SampleAnnotation$ChIP_ID))
SampleAnnotation$abutler_groundTruthForPlotting = rep("oob",length(SampleAnnotation$ChIP_ID))


  for (i in 1:length(SampleAnnotation$ChIP_ID)){
  
  #group 1 = B's in pooled (2456)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "1"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab1"
  }
  
  #group 2 = B's in numbered (2456)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "2"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab1"
  }
  
  #group 3 = D's in pooled 
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "3"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab2"
  }
  
  #group 4 = D's in numbered 
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R02","R04","R05","R06")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "4"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab2"
  }
  
  #group 5 = D's in pooled
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "5"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab3"
  }
  
  #group 6 = D's in numbered
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "6"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab3"
  }
  
  #group 7 = B's in pooled (1,3,7,8)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "7"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab4"
  }
  
  #group 8 = B's in numbered (1,3,7,8)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R01","R03","R07","R08")
      )
    {
    SampleAnnotation$abutler_4v4[i] = "8"
    SampleAnnotation$abutler_groundTruthForPlotting[i] = "ab4"
  }
  
}
```


### Plots 1v2 (BP2456 vs BN2456)

```{r}
# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_4v4 == "1" | 
           SampleAnnotation$abutler_4v4 == "2")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab1 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab1 = fig_differential_methylation_BH_pValues_ab1 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP2456 vs BN2456') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))

fig_differential_methylation_BH_pValues_ab1


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab1 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab1$variable = as.character(upset_df_ab1$variable)
upset_df_ab1 = upset_df_ab1 %>%
  filter(value < 0.05)

upset_df_ab1 = upset_df_ab1 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_1v2_ab1 = upset_df_ab1 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("BP2456 vs BN2456")
upset_gg_1v2_ab1

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_1v2 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_1v2

list_of_dfs_ab1 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP2456vsBN2456.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab1
dev.off()


```

#### stdevratio
```{r}

# used a couple of times to aggregate dataframes by common rownames
rename_cols_and_aggregate = function(list_of_dfs){
  for (i in 1:length(list_of_dfs)){
    old_colnames = colnames(list_of_dfs[[i]])
    add_to_colname = names(list_of_dfs[i])
    new_colnames = paste0(old_colnames,"_",add_to_colname)
    colnames(list_of_dfs[[i]]) = new_colnames
  }
  for (i in 1:length(list_of_dfs)){
   if (i == 1){
     df_cbind = list_of_dfs[[i]]
   }
    else {df_cbind = merge(df_cbind,list_of_dfs[[i]],by = 'row.names')
    rownames(df_cbind) = df_cbind$Row.names
    df_cbind$Row.names = NULL}
  }
  return(df_cbind)
}

# plot_p_values

plot_p_values = function(list_of_dfs,dmp_cpgs){
  
  aggregated_dfs = rename_cols_and_aggregate(list_of_dfs)
  
  if (length(dmp_cpgs) >= 1000){
  aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    slice_sample(n = 1000) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.02) +
            ylab("beta value")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)
  }
  
  else {aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.02) +
            ylab("beta value")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)}
}

# list_of_dfs = list(raw = dmp_unnormalized_categorical,
#            sesame = dmp_sesame_categorical,
#            combat = dmp_normalized_combat1_categorical,
#            combatFI = dmp_ComBatSeqFI)
# 
upset_df_to_plotted_p_values = function(list_of_dfs,upset_df){
  # comparisons:
  
  
  
  
  
  library(stringr)
  
  ## only unnormalized:
  
  dmps_raw_only = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
  plot_p_values(list_of_dfs,dmps_raw_only)

  ## only sesame:
  
  dmps_sesame_only = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_sesame_only)

  
  ## only after combat
  
  dmps_after_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combat)

  
## only after combatFI
  
  dmps_after_combatFI = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combatFI)

  
## only after sesame
  
  dmps_after_sesame_including_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_sesame_including_combat)

  
## everything
  
  dmps_everything = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_everything)

  
}



betas_list = list(raw = df_unnormalized,
                  sesame = df_normalized,
                  combatBetas = df_normalized_with_combat,
                  combatFI = ComBatFI_seq_betas)


betas_list_merged = rename_cols_and_aggregate(betas_list)

# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)
betas_list = list(raw = df_unnormalized,
                  sesame = df_normalized,
                  combatBetas = df_normalized_with_combat,
                  combatFI = ComBatFI_seq_betas)


betas_list_merged = rename_cols_and_aggregate(betas_list)



# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL)

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject b
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject d
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))



```



### Plots 3v4 (DP2456 vs DN2456)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_4v4 == "3" | 
           SampleAnnotation$abutler_4v4 == "4")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")






# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab2 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab2 = fig_differential_methylation_BH_pValues_ab2 + 
  plot_annotation(tag_levels = 'a',
                  title = 'DP2456 vs DN2456') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab2



all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab2 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab2$variable = as.character(upset_df_ab2$variable)
upset_df_ab2 = upset_df_ab2 %>%
  filter(value < 0.05)

upset_df_ab2 = upset_df_ab2 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_3v4_ab2 = upset_df_ab2 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("DP2456 vs DN2456")
upset_gg_3v4_ab2

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_3v4 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_3v4

list_of_dfs_ab2 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)



library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_DP2456vsDN2456.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab2
dev.off()


```

### Plots 5v6 (DN1378 vs DP1378)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_4v4 == "5" | 
           SampleAnnotation$abutler_4v4 == "6")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3

# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab3 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab3 = fig_differential_methylation_BH_pValues_ab3 + 
  plot_annotation(tag_levels = 'a',
                  title = 'DP1378 vs DN1378') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab3


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab3 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab3$variable = as.character(upset_df_ab3$variable)
upset_df_ab3 = upset_df_ab3 %>%
  filter(value < 0.05)

upset_df_ab3 = upset_df_ab3 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_5v6_ab3 = upset_df_ab3 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("DN1378 vs DP1378")
upset_gg_5v6_ab3

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_5v6 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_5v6
list_of_dfs_ab3 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_DP1378vsDN1378.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab3
dev.off()


```

```{r}

```


### Plots 7v8 (BP1378 vs BN1378)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_4v4 == "7" | 
           SampleAnnotation$abutler_4v4 == "8")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_4v4)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab4 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab4 = fig_differential_methylation_BH_pValues_ab4 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP1378 vs BN1378') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab4

all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab4 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab4$variable = as.character(upset_df_ab4$variable)
upset_df_ab4 = upset_df_ab4 %>%
  filter(value < 0.05)

upset_df_ab4 = upset_df_ab4 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_7v8_ab4 = upset_df_ab4 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("BP1378 vs BN1378")
#upset_gg_7v8_ab4

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

list_of_dfs_ab4 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP1378vsBN1378.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab4
dev.off()


```

```{r}
format_ggupset = function(ggplot_object){
  ggplot_object + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          text = element_text(family = "Helvetica", size = 6),
          axis.text.y = element_text(size = 6),
          axis.title = element_text(size = 6)) + 
    theme_combmatrix(
      combmatrix.label.make_space = TRUE,
      combmatrix.label.width = NULL,
      combmatrix.label.height = NULL,
      combmatrix.label.extra_spacing = 3,
      combmatrix.label.total_extra_spacing = unit(10, "pt"),
      combmatrix.label.text = NULL,
      combmatrix.panel.margin = unit(c(1.5, 1.5), "pt"),
      combmatrix.panel.striped_background = TRUE,
      combmatrix.panel.striped_background.color.one = "white",
      combmatrix.panel.striped_background.color.two = "#F7F7F7",
      combmatrix.panel.point.size = 0.5,
      combmatrix.panel.line.size = 0.25,
      combmatrix.panel.point.color.fill = "black",
      combmatrix.panel.point.color.empty = "#E0E0E0")
}
```


# plots
```{r}
# library(patchwork)
# f_upset_gg_1v2_ab1 = format_ggupset(upset_gg_1v2_ab1)
# #f_upset_gg_3v4_ab2 = format_ggupset(upset_gg_3v4_ab2)
# f_upset_gg_5v6_ab3 = format_ggupset(upset_gg_5v6_ab3)
# #f_upset_gg_7v8_ab4 = format_ggupset(upset_gg_7v8_ab4) no upset bc no diff methylated cpgs
# 
# 
# 
# 
# f_upset_gg_1v2_ab1 + plot_spacer() +
#   f_upset_gg_3v4_ab2 + f_upset_gg_5v6_ab3 + plot_layout(ncol = 2)
# 


```

# upset plots for each pipeline
```{r}
upset_df_dv1$comparison = "BP2456vsDP2456"
upset_df_dv2$comparison = "BN1234vsBN5678"
upset_df_dv3$comparison = "DN1234vsDN5678"
upset_df_dv4$comparison = "DP1378vsBP1378"

upset_df_ab1$comparison = "BP2456vsBN2456"
upset_df_ab2$comparison = "DP2456vsDN2456"
upset_df_ab3$comparison = "DN1378vsDP1378"
upset_df_ab4$comparison = "BP1378vsBN1378"




upset_dv_combined = rbind(upset_df_dv1,
                          upset_df_dv2,
                          upset_df_dv3,
                          upset_df_dv4)

upset_dv_and_ab_combined = rbind(upset_df_ab1,
                          upset_df_ab2,
                          upset_df_ab3,
                          upset_df_ab4)

upset_comb_positive = rbind(upset_df_dv1,
                            upset_df_dv4)

upset_comb_positive_and_negative = rbind(upset_dv_combined,
                            upset_dv_and_ab_combined)

pipelines = paste0(names,"_padj")

upset_dv_combined2 = upset_dv_combined
upset_dv_and_ab_combined2 = upset_dv_and_ab_combined
upset_comb_positive2 = upset_comb_positive

#dv
for (j in 1:length(pipelines)){
  temp = c()
  for (i in 1:length(upset_dv_combined2$variable)){
    temp[i] = pipelines[j] %in% upset_dv_combined$variable[[i]]
  }
  
  newnames = c(colnames(upset_dv_combined2),pipelines[j])
  upset_dv_combined2 = cbind(upset_dv_combined2,temp)
  colnames(upset_dv_combined2) = newnames
}

#ab
for (j in 1:length(pipelines)){
  temp = c()
  for (i in 1:length(upset_dv_and_ab_combined2$variable)){
    temp[i] = pipelines[j] %in% upset_dv_combined$variable[[i]]
  }
  
  newnames = c(colnames(upset_dv_and_ab_combined2),pipelines[j])
  upset_dv_and_ab_combined2 = cbind(upset_dv_and_ab_combined2,temp)
  colnames(upset_dv_and_ab_combined2) = newnames
}

#pos
for (j in 1:length(pipelines)){
  temp = c()
  for (i in 1:length(upset_comb_positive$variable)){
    temp[i] = pipelines[j] %in% upset_comb_positive$variable[[i]]
  }
  
  newnames = c(colnames(upset_comb_positive),pipelines[j])
  upset_comb_positive = cbind(upset_comb_positive,temp)
  colnames(upset_comb_positive) = newnames
}


#pos and neg
for (j in 1:length(pipelines)){
  temp = c()
  for (i in 1:length(upset_comb_positive_and_negative$variable)){
    temp[i] = pipelines[j] %in% upset_comb_positive_and_negative$variable[[i]]
  }
  
  newnames = c(colnames(upset_comb_positive_and_negative),pipelines[j])
  upset_comb_positive_and_negative = cbind(upset_comb_positive_and_negative,temp)
  colnames(upset_comb_positive_and_negative) = newnames
}


#dmp_ComBatSeqFI_padj
upset_dmp_ComBatSeqFI_padj = upset_dv_combined2 %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBatSeqFI")
upset_dmp_ComBatSeqFI_padj =format_ggupset(upset_dmp_ComBatSeqFI_padj)
upset_dmp_ComBatSeqFI_padj


#dmp_normalized_combat1_categorical_padj
upset_dmp_normalized_combat1_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBat")
upset_dmp_normalized_combat1_categorical_padj =format_ggupset(upset_dmp_normalized_combat1_categorical_padj)
upset_dmp_normalized_combat1_categorical_padj

#dmp_sesame_categorical_padj
upset_dmp_sesame_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe")
upset_dmp_sesame_categorical_padj =format_ggupset(upset_dmp_sesame_categorical_padj)
upset_dmp_sesame_categorical_padj

#dmp_unnormalized_categorical_padj
upset_dmp_unnormalized_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_dmp_unnormalized_categorical_padj = format_ggupset(upset_dmp_unnormalized_categorical_padj)
upset_dmp_unnormalized_categorical_padj

# remade with new dfs ################

#dmp_ComBatSeqFI_padj
upset_dmp_ComBatSeqFI_padj_new = upset_dv_and_ab_combined2 %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBatSeqFI")
upset_dmp_ComBatSeqFI_padj_new =format_ggupset(upset_dmp_ComBatSeqFI_padj_new)
upset_dmp_ComBatSeqFI_padj_new


#dmp_normalized_combat1_categorical_padj
upset_dmp_normalized_combat1_categorical_padj_new = upset_dv_and_ab_combined2 %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBat")
upset_dmp_normalized_combat1_categorical_padj_new =format_ggupset(upset_dmp_normalized_combat1_categorical_padj_new)
upset_dmp_normalized_combat1_categorical_padj_new

#dmp_sesame_categorical_padj
upset_dmp_sesame_categorical_padj_new = upset_dv_and_ab_combined2 %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe")
upset_dmp_sesame_categorical_padj_new =format_ggupset(upset_dmp_sesame_categorical_padj_new)
upset_dmp_sesame_categorical_padj_new

#dmp_unnormalized_categorical_padj
upset_dmp_unnormalized_categorical_padj_new = upset_dv_and_ab_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_dmp_unnormalized_categorical_padj_new = format_ggupset(upset_dmp_unnormalized_categorical_padj_new)
upset_dmp_unnormalized_categorical_padj_new

```

```{r}
# raw
upset_comb_positive_new = upset_comb_positive %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_comb_positive_new = format_ggupset(upset_comb_positive_new)
upset_comb_positive_new

# raw
upset_comb_positive_new = upset_comb_positive %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_comb_positive_new = format_ggupset(upset_comb_positive_new)
upset_comb_positive_new

# raw
upset_comb_positive_new = upset_comb_positive %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_comb_positive_new = format_ggupset(upset_comb_positive_new)
upset_comb_positive_new

# raw
upset_comb_positive_new = upset_comb_positive %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_comb_positive_new = format_ggupset(upset_comb_positive_new)
upset_comb_positive_new
```

```{r}
library(ggvenn)
# raw
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

saveRDS(a,"vennlist_raw.Rds")

positive_raw = ggvenn(a) + 
  ggtitle("Raw")


# sesame
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesame = ggvenn(a) + 
  ggtitle("SeSAMe")

saveRDS(a,"vennlist_sesame.Rds")


# sesame + combat
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesameCombat = ggvenn(a) + 
  ggtitle("SeSAMe + ComBat")

saveRDS(a,"vennlist_sesameCombat.Rds")

# sesame + ComBatSeqFI
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesameCombatSeqFI = ggvenn(a) + 
  ggtitle("SeSAMe + ComBatSeqFI")

saveRDS(a,"vennlist_ComBatFI.Rds")


library(patchwork)
positive_raw
positive_sesame
positive_sesameCombat
positive_sesameCombatSeqFI

(positive_raw | positive_sesame )/  (positive_sesameCombat + positive_sesameCombatSeqFI)
```

## scaled venn diagrams
```{r}
library(ggvenn)
# raw
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

saveRDS(a,"vennlist_raw.Rds")

positive_raw = ggvenn(a,auto_scale = T) + 
  ggtitle("Raw")


# sesame
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesame = ggvenn(a,auto_scale = T) + 
  ggtitle("SeSAMe")

saveRDS(a,"vennlist_sesame.Rds")


# sesame + combat
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesameCombat = ggvenn(a,auto_scale = T) + 
  ggtitle("SeSAMe + ComBat")

saveRDS(a,"vennlist_sesameCombat.Rds")

# sesame + ComBatSeqFI
BP2456vsDP2456_cpgs = upset_comb_positive %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs)

positive_sesameCombatSeqFI = ggvenn(a,auto_scale = T) + 
  ggtitle("SeSAMe + ComBatSeqFI")

saveRDS(a,"vennlist_ComBatFI.Rds")


library(patchwork)
positive_raw
positive_sesame
positive_sesameCombat
positive_sesameCombatSeqFI

(positive_raw | positive_sesame )/  (positive_sesameCombat + positive_sesameCombatSeqFI)


```
,auto_scale = T

```{r}
upset_comb_positive_and_negative


library(ggvenn)
# raw
BP2456vsDP2456_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs

all_negative_control_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison != "DP1378vsBP1378") %>%
  filter(comparison != "BP2456vsDP2456") %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
all_negative_control_cpgs = all_negative_control_cpgs$cpgs

  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs,
          `all_negative_control_cpgs` = all_negative_control_cpgs)

positive2_raw = ggvenn(a) + 
  ggtitle("Raw")

# sesame
BP2456vsDP2456_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
all_negative_control_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison != "DP1378vsBP1378") %>%
  filter(comparison != "BP2456vsDP2456") %>%
  filter(dmp_sesame_categorical_padj == TRUE)
all_negative_control_cpgs = all_negative_control_cpgs$cpgs

  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs,
          `all_negative_control_cpgs` = all_negative_control_cpgs)

positive2_sesame = ggvenn(a) + 
  ggtitle("SeSAMe")

# sesame + combat
BP2456vsDP2456_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
all_negative_control_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison != "DP1378vsBP1378") %>%
  filter(comparison != "BP2456vsDP2456") %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE)
all_negative_control_cpgs = all_negative_control_cpgs$cpgs

a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs,
          `all_negative_control_cpgs` = all_negative_control_cpgs)

positive2_sesameCombat = ggvenn(a) + 
  ggtitle("SeSAMe + ComBat")

# sesame + ComBatSeqFI
BP2456vsDP2456_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "BP2456vsDP2456") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
BP2456vsDP2456_cpgs = BP2456vsDP2456_cpgs$cpgs
DP1378vsBP1378_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison == "DP1378vsBP1378") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
DP1378vsBP1378_cpgs = DP1378vsBP1378_cpgs$cpgs
  
all_negative_control_cpgs = upset_comb_positive_and_negative %>%
  filter(comparison != "DP1378vsBP1378") %>%
  filter(comparison != "BP2456vsDP2456") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE)
all_negative_control_cpgs = all_negative_control_cpgs$cpgs

  
a <- list(`BP2456vsDP2456` = BP2456vsDP2456_cpgs,
          `DP1378vsBP1378` = DP1378vsBP1378_cpgs,
          `all_negative_control_cpgs` = all_negative_control_cpgs)

positive2_sesameCombatSeqFI = ggvenn(a) + 
  ggtitle("SeSAMe + ComBatSeqFI")

library(patchwork)
positive2_raw
positive2_sesame
positive2_sesameCombat
positive2_sesameCombatSeqFI
```



# abutler_3v3

```{r}
SampleAnnotation$abutler_3v3 = rep("oob",length(SampleAnnotation$ChIP_ID))
SampleAnnotation$abutler_groundTruthForPlotting2 = rep("oob",length(SampleAnnotation$ChIP_ID))


  for (i in 1:length(SampleAnnotation$ChIP_ID)){
  
  #group 1 = BP's on single slide (678)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R06","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "1"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab5"
  }
  
  #group 2 = BN's on single slide (678)
  if (SampleAnnotation$subjectLetter[i] == "B" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R06","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "2"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab5"
  }
  
  #group 3 = DP's on single slide (123)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R01","R02","R03")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "3"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab6"
  }
  
  #group 4 = DN's on single slide (123)
  if (SampleAnnotation$subjectLetter[i] == "D" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R01","R02","R03")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "4"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab6"
  }
  
  #group 5 = A's in pooled
  if (SampleAnnotation$subjectLetter[i] == "A" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "5"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab7"
  }
  
  #group 6 = A's in numbered
  if (SampleAnnotation$subjectLetter[i] == "A" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R05","R06","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "6"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab7"
  }
  
  #group 7 = C's in pooled
  if (SampleAnnotation$subjectLetter[i] == "C" & 
      SampleAnnotation$pooled[i]==TRUE &
      SampleAnnotation$lane[i] %in% c("R05","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "7"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab8"
  }
  
  #group 8 = C's in numbered (5,7,8)
  if (SampleAnnotation$subjectLetter[i] == "C" & 
      SampleAnnotation$pooled[i]==FALSE &
      SampleAnnotation$lane[i] %in% c("R05","R07","R08")
      )
    {
    SampleAnnotation$abutler_3v3[i] = "8"
    SampleAnnotation$abutler_groundTruthForPlotting2[i] = "ab8"
  }
  
}
```


### Plots 1v2 (BP678 vs BN678)


```{r}
# Filter out the samples of interest
SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_3v3 == "1" | 
           SampleAnnotation$abutler_3v3 == "2")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


library(ggplot2)
# The code below will generate the graph:

# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab5 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab5 = fig_differential_methylation_BH_pValues_ab5 + 
  plot_annotation(tag_levels = 'a',
                  title = 'BP678 vs BN678') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))

fig_differential_methylation_BH_pValues_ab5


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab5 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab5$variable = as.character(upset_df_ab5$variable)
upset_df_ab5 = upset_df_ab5 %>%
  filter(value < 0.05)

upset_df_ab5 = upset_df_ab5 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_1v2_ab5 = upset_df_ab5 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("BP678 vs BN678")
upset_gg_1v2_ab5

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_1v2 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_1v2

list_of_dfs_ab5 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_BP2456vsBN2456.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab5
dev.off()

```
```{r}

```



### Plots 3v4 (DP123 vs DN123)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_3v3 == "3" | 
           SampleAnnotation$abutler_3v3 == "4")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")






# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3

# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab6 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab6 = fig_differential_methylation_BH_pValues_ab6 + 
  plot_annotation(tag_levels = 'a',
                  title = 'DP123 vs DN123') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab6



all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab6 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab6$variable = as.character(upset_df_ab6$variable)
upset_df_ab6 = upset_df_ab6 %>%
  filter(value < 0.05)

upset_df_ab6 = upset_df_ab6 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_3v4_ab6 = upset_df_ab6 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("DP123 vs DN123")
#upset_gg_3v4_ab6

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_3v4 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_3v4

list_of_dfs_ab6 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_DP123vsDN123.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab6
dev.off()


```

### Plots 5v6 (AN5678 vs AP5678)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_3v3 == "5" | 
           SampleAnnotation$abutler_3v3 == "6")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab7 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab7 = fig_differential_methylation_BH_pValues_ab7 + 
  plot_annotation(tag_levels = 'a',
                  title = 'AN5678 vs AP5678') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab7


all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",

                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab7 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab7$variable = as.character(upset_df_ab7$variable)
upset_df_ab7 = upset_df_ab7 %>%
  filter(value < 0.05)

upset_df_ab7 = upset_df_ab7 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_5v6_ab7 = upset_df_ab7 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("AP5678 vs AN5678")
upset_gg_5v6_ab7

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

# upset_5v6 = UpSetR::upset(merged_df_onehot,
#                           nsets = 6, 
#                           nintersects = NA,
#                           order.by="freq",
#                           text.scale = 0.5)
# upset_5v6

list_of_dfs_ab7 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_AN5678vsAP5678.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab7
dev.off()


```

### Plots 7v8 (CP578 vs CN578)

```{r}
library(ggplot2)
# The code below will generate the graph:

SampleNames = SampleAnnotation %>%
  filter(SampleAnnotation$abutler_3v3 == "7" | 
           SampleAnnotation$abutler_3v3 == "8")

# df_normalized
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_normalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_sesame_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_unnormalized
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

betas_numbered = df_unnormalized %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_unnormalized_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")

# df_normalized_with_combat
df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL

df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

betas_numbered = df_normalized_with_combat %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_normalized_combat1_categorical = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# ComBat_seq on FIs
compiled_beta_values = readRDS("compiled_beta_values.Rds")
ComBatFI_seq_betas = compiled_beta_values[[2]]

betas_numbered = ComBatFI_seq_betas %>%
  select(SampleNames$XChipID)

dat = as.matrix(betas_numbered)
my_phenotype = as.factor(SampleNames$abutler_3v3)
my_phenotype = droplevels(my_phenotype)
dmp_ComBatSeqFI = dmpFinder(dat, pheno = my_phenotype  , type = "categorical")


# graph2
dmp_sesame_categorical$p_values_corrected <- p.adjust(dmp_sesame_categorical$pval, method = "fdr")

count_below <- dmp_sesame_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph2 <- ggplot(dmp_sesame_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() +
    #ylim(0,125000) +
  ggtitle("SeSAMe") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph2

# graph1
dmp_unnormalized_categorical$p_values_corrected <- p.adjust(dmp_unnormalized_categorical$pval, method = "fdr")

count_below <- dmp_unnormalized_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())
graph1 <- ggplot(dmp_unnormalized_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) +
  ggtitle("Raw") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))
graph1

dmp_normalized_combat1_categorical$p_values_corrected <- p.adjust(dmp_normalized_combat1_categorical$pval, method = "fdr")

count_below <- dmp_normalized_combat1_categorical %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

# graph3
graph3 <- ggplot(dmp_normalized_combat1_categorical, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
    #ylim(0,125000) + 

  ggtitle("SeSAMe + ComBat") + 
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36))  #+
  #scale_y_log10()
graph3


# graph6
dmp_ComBatSeqFI$p_values_corrected <- p.adjust(dmp_ComBatSeqFI$pval, method = "fdr")

count_below <- dmp_ComBatSeqFI %>% filter(p_values_corrected < 0.05) %>% summarise(count = n())

graph6 <- ggplot(dmp_ComBatSeqFI, aes(x = p_values_corrected)) +
  geom_histogram(position = 'identity', alpha = 0.8, binwidth = 0.01, fill = "grey50") +
  theme_bw() + 
  #ylim(0,125000) + 
  ggtitle("SeSAME + ComBatSeqFI")+
  theme(text = element_text(size = 5))  +
  geom_text(data = count_below, aes(x = Inf, y = Inf, hjust = 1, vjust = 1, label = paste0("p<0.05: ", count)), size = (5*0.36)) +
  theme(text = element_text(size = 5)) 

graph6

library(patchwork)
fig_differential_methylation_BH_pValues_ab8 = (graph1 | graph2) / (graph3 | graph6)
  
fig_differential_methylation_BH_pValues_ab8 = fig_differential_methylation_BH_pValues_ab8 + 
  plot_annotation(tag_levels = 'a',
                  title = 'CP578 vs CN578') & 
  theme(plot.tag = element_text(size = 8),
        plot.title = element_text(size = 8))


fig_differential_methylation_BH_pValues_ab8

all_de_cpgs = unique(c(rownames(dmp_unnormalized_categorical),
                rownames(dmp_sesame_categorical),
                rownames(dmp_normalized_combat1_categorical),


                rownames(dmp_ComBatSeqFI)))

# function to select sigs
select_sig_cpgs_for_merge = function(dataframe){
  df_name <- deparse(substitute(dataframe))

  pruned = data.frame(cpgs = rownames(dataframe),
                      padj = dataframe %>%
                        select(p_values_corrected))
  
  colnames(pruned)[2] = paste0(df_name,"_","padj")
  return(pruned)
}

list_of_dfs = list(
                   dmp_ComBatSeqFI,

                   dmp_normalized_combat1_categorical,
                   dmp_sesame_categorical,
                   dmp_unnormalized_categorical)
names(list_of_dfs) = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")
names = c(
                   "dmp_ComBatSeqFI",
                   "dmp_normalized_combat1_categorical",
                   "dmp_sesame_categorical",
                   "dmp_unnormalized_categorical")

# prune columns
list_of_dfs = lapply(list_of_dfs, select_sig_cpgs_for_merge)

# rename pval col
for (i in 1:length(list_of_dfs)){
  colnames(list_of_dfs[[i]])[2] = paste0(names[i],"_padj")
}

#merge into a single df
for (i in 1:length(list_of_dfs)){
  if (i == 1){
    merged_df2 = list_of_dfs[[1]]
  }
  if(i > 1){
    merged_df2 = merge(merged_df2,list_of_dfs[[i]], all.x = TRUE,all.y = TRUE)
  }
}

# upset plots
merged_df_onehot = merged_df2
rownames(merged_df_onehot) = merged_df_onehot$cpgs
upset_df_ab8 = reshape2::melt(merged_df_onehot, ids = cpgs)
upset_df_ab8$variable = as.character(upset_df_ab8$variable)
upset_df_ab8 = upset_df_ab8 %>%
  filter(value < 0.05)

upset_df_ab8 = upset_df_ab8 %>%
  group_by(cpgs) %>%
  summarize(variable = list(variable))

library(ggupset)
upset_gg_7v8_ab8 = upset_df_ab8 %>%
  ggplot(aes(x = variable)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
  ggtitle("CP578 vs CN578")
upset_gg_7v8_ab8

merged_df_onehot$cpgs = NULL
merged_df_onehot = ifelse(merged_df_onehot < 0.05, 1, 0)
merged_df_onehot = data.frame(merged_df_onehot)

list_of_dfs_ab8 = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)

library(patchwork)
### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "differential_methylation_CP578vsCN578.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (45/25.4)) # The height of the plot in inches
fig_differential_methylation_BH_pValues_ab8
dev.off()


```

```{r}
format_ggupset = function(ggplot_object){
  ggplot_object + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          text = element_text(family = "Helvetica", size = 6),
          axis.text.y = element_text(size = 6),
          axis.title = element_text(size = 6)) + 
    theme_combmatrix(
      combmatrix.label.make_space = TRUE,
      combmatrix.label.width = NULL,
      combmatrix.label.height = NULL,
      combmatrix.label.extra_spacing = 3,
      combmatrix.label.total_extra_spacing = unit(10, "pt"),
      combmatrix.label.text = NULL,
      combmatrix.panel.margin = unit(c(1.5, 1.5), "pt"),
      combmatrix.panel.striped_background = TRUE,
      combmatrix.panel.striped_background.color.one = "white",
      combmatrix.panel.striped_background.color.two = "#F7F7F7",
      combmatrix.panel.point.size = 0.5,
      combmatrix.panel.line.size = 0.25,
      combmatrix.panel.point.color.fill = "black",
      combmatrix.panel.point.color.empty = "#E0E0E0")
}
```


# plots
```{r}
f_upset_gg_1v2_ab5 = format_ggupset(upset_gg_1v2_ab5)
#f_upset_gg_3v4_ab6 = format_ggupset(upset_gg_3v4_ab6)
f_upset_gg_5v6_ab7 = format_ggupset(upset_gg_5v6_ab7)
f_upset_gg_7v8_ab8 = format_ggupset(upset_gg_7v8_ab8)




f_upset_gg_1v2_ab5 + #f_upset_gg_3v4_ab6 +
  f_upset_gg_5v6_ab7 + f_upset_gg_7v8_ab8 + plot_layout(ncol = 2)


```

# upset plots for each pipeline
```{r}
upset_df_dv1$comparison = "BP2456vsDP2456"
upset_df_dv2$comparison = "BN1234vsBN5678"
upset_df_dv3$comparison = "DN1234vsDN5678"
upset_df_dv4$comparison = "DP1378vsBP1378"

upset_dv_combined = rbind(upset_df_dv1,
                          upset_df_dv2,
                          upset_df_dv3,
                          upset_df_dv4)

pipelines = paste0(names,"_padj")

upset_dv_combined2 = upset_dv_combined

for (j in 1:length(pipelines)){
  temp = c()
  for (i in 1:length(upset_dv_combined2$variable)){
    temp[i] = pipelines[j] %in% upset_dv_combined$variable[[i]]
  }
  
  newnames = c(colnames(upset_dv_combined2),pipelines[j])
  upset_dv_combined2 = cbind(upset_dv_combined2,temp)
  colnames(upset_dv_combined2) = newnames
}

#dmp_ComBatSeqFI_padj
upset_dmp_ComBatSeqFI_padj = upset_dv_combined2 %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBatSeqFI")
upset_dmp_ComBatSeqFI_padj =format_ggupset(upset_dmp_ComBatSeqFI_padj)
upset_dmp_ComBatSeqFI_padj

#dmp_normalized_combat1_categorical_padj
upset_dmp_normalized_combat1_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe+ComBat")
upset_dmp_normalized_combat1_categorical_padj =format_ggupset(upset_dmp_normalized_combat1_categorical_padj)
upset_dmp_normalized_combat1_categorical_padj

#dmp_sesame_categorical_padj
upset_dmp_sesame_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("SeSAMe")
upset_dmp_sesame_categorical_padj =format_ggupset(upset_dmp_sesame_categorical_padj)
upset_dmp_sesame_categorical_padj

#dmp_unnormalized_categorical_padj
upset_dmp_unnormalized_categorical_padj = upset_dv_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison)) %>%
  ggplot(aes(x = comparison)) +
    geom_bar(fill = "grey50") +
    scale_x_upset() + 
    #ylim(0,150000)+
  ggtitle("Raw")
upset_dmp_unnormalized_categorical_padj =format_ggupset(upset_dmp_unnormalized_categorical_padj)
upset_dmp_unnormalized_categorical_padj



```

```{r}
saveRDS(upset_dv_combined2,"upset_dv_combined2_fdr.Rds")

```

```{r}
unique(upset_dv_combined2$comparison)
```


```{r}
upset_dv_combined2 = readRDS("upset_dv_combined2.Rds")
library(dplyr)
comparisons_sig = upset_dv_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison))

# none
false_positive_all = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
  
# 1
false_positive_all_but_ = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

# 20
false_positive_all_standard_pipeline = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
```

# plotting beta values

```{r}
library(readr)
# loading beta values
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL
df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

# ComBat FI betas
ComBatFI_seq_betas = compiled_beta_values[[2]]


```

```{r}

library(ggplot2)
make_cpgs = function(dataframe){
  dataframe$cpgs = rownames(dataframe)
  return(dataframe)
}





# example
cpg_vector = false_positive_all_standard_pipeline$cpgs

plot_ten_betas = function(cpg_vector){
  
  number_of_genes = length(cpg_vector) # count number of genes
  
  # filter to only target gene
  for (i in 1:20){
    raw = df_unnormalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame = df_normalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame_combat = df_normalized_with_combat %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame_combatFI_seq = ComBatFI_seq_betas %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)

    # Add columns for each dataset that detected the CpG
    
    each_gene = data.frame(sample = colnames(raw),
      raw_betas = as.numeric(raw[1,])) # should always be there
    
    # Add other dfs (might not be there depending on filtering)
    if (length(sesame > 0)){
      each_gene$sesame_betas = as.numeric(sesame[1,])
    }
    
    if (length(sesame_combat > 0)){
      each_gene$sesame_combat_betas = as.numeric(sesame_combat[1,])
    }

    if (length(sesame_combatFI_seq > 0)){
      each_gene$sesame_combatFI_seq_betas = as.numeric(sesame_combatFI_seq[1,])
    }

    melted_data = reshape2::melt(each_gene)

    graph <- ggplot(melted_data, aes(x = variable, y = value, colour = variable)) +
      geom_boxplot(notch = TRUE) +
      geom_jitter(size = 1, alpha = 0.5, width = 0.25, colour = 'black') +
      theme_bw() + 
      ggtitle(as.character(cpg_vector[i]))
    plot(graph)
  }
  
}
#temp = plot_all_betas(false_positive_all_standard_pipeline$cpgs)

```

# plots with points colored by subject
```{r}

library(ggplot2)
make_cpgs = function(dataframe){
  dataframe$cpgs = rownames(dataframe)
  return(dataframe)
}





# example
cpg_vector = false_positive_all_standard_pipeline$cpgs

plot_all_betas = function(cpg_vector){
  
  number_of_genes = length(cpg_vector) # count number of genes
  
  # filter to only target gene
  for (i in 1:number_of_genes){
    raw = df_unnormalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"])
    sesame = df_normalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"])
    sesame_combat = df_normalized_with_combat %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"])
    sesame_combatFI_seq = ComBatFI_seq_betas %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"])

    # Add columns for each dataset that detected the CpG
    
    each_gene = data.frame(sample = colnames(raw),
      raw_betas = as.numeric(raw[1,])) # should always be there
    
    # Add other dfs (might not be there depending on filtering)
    if (length(sesame > 0)){
      each_gene$sesame_betas = as.numeric(sesame[1,])
    }
    
    if (length(sesame_combat > 0)){
      each_gene$sesame_combat_betas = as.numeric(sesame_combat[1,])
    }

    if (length(sesame_combatFI_seq > 0)){
      each_gene$sesame_combatFI_seq_betas = as.numeric(sesame_combatFI_seq[1,])
    }

    melted_data = reshape2::melt(each_gene)
    
    samples_by_subject = c()
    for (i in 1:length(melted_data$sample)){
      samples_by_subject[i] =  SampleAnnotation$subjectLetter[SampleAnnotation$XChipID == melted_data$sample[i]]
    }
    melted_data$subject = as.factor(samples_by_subject)

    graph <- ggplot(melted_data, aes(x = variable, y = value, colour = variable)) +
      geom_boxplot(notch = TRUE) +
      geom_jitter(size = 1, alpha = 0.5, width = 0.25, aes(colour = subject)) +
      theme_bw() + 
      ggtitle(as.character(cpg_vector[i]))
    plot(graph)
  }
  
}
#temp = plot_all_betas(false_positive_all_standard_pipeline$cpgs)

```

# false positive cpgs
```{r}
upset_dv_combined2 = readRDS("upset_dv_combined2.Rds")
library(dplyr)
comparisons_sig = upset_dv_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison))

# none
false_positive_all_but_combat = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == FALSE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)
  
# 
false_positive_all_but_combatFI = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == FALSE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

# 
false_positive_all_pipelines = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

# raw
false_positive_raw_only = upset_dv_combined2 %>%
  filter(comparison == "BN1234vsBN5678" | comparison == "DN1234vsDN5678") %>%
  filter(dmp_ComBatSeqFI_padj == FALSE) %>%
  filter(dmp_normalized_combat1_categorical_padj == FALSE) %>%
  filter(dmp_sesame_categorical_padj == FALSE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

dmp_unnormalized_categorical = dmp_unnormalized_categorical %>%
  arrange(by="pval")
dmp_sesame_categorical = dmp_sesame_categorical %>%
  arrange(by="pval")
dmp_ComBatSeqFI = dmp_ComBatSeqFI %>%
  arrange(by="pval")
dmp_normalized_combat1_categorical = dmp_normalized_combat1_categorical %>%
  arrange(by="pval")

most_sig_cpgs_raw = rownames(dmp_unnormalized_categorical[1:10,])
most_sig_cpgs_sesame = rownames(dmp_sesame_categorical[1:10,])
most_sig_cpgs_sesameCombatBetas = rownames(dmp_normalized_combat1_categorical[1:10,])
most_sig_cpgs_sesameCombatFI = rownames(dmp_ComBatSeqFI[1:10,])



```

### plotting beta values

```{r}
library(readr)
# loading beta values
df_normalized = readRDS("df_normalized_RemNAmedianImpute070122023.Rds")
df_unnormalized = readRDS("df_unnormalized_RemNAmedianImpute070122023.Rds")

df_normalized_with_combat = read_csv("/home/sagemaker-user/dnamstability/dnamstability-abutler/data/raw_fluorescence_values/sesameAndCombat_normalized_betas_for_kras_20230317.csv")
df_normalized_with_combat = data.frame(df_normalized_with_combat)
rownames(df_normalized_with_combat) = df_normalized_with_combat$cpgs # rownames for the csv
df_normalized_with_combat$cpgs = NULL
df_normalized_with_combat$X205832330169_R03C01 = NULL #drop outlier

# ComBat FI betas
ComBatFI_seq_betas = compiled_beta_values[[2]]


```

### plots with points colored by subject
```{r}

library(ggplot2)
make_cpgs = function(dataframe){
  dataframe$cpgs = rownames(dataframe)
  return(dataframe)
}





# example
cpg_vector_test = false_positive_all_pipelines$cpgs

plot_all_betas = function(cpg_vector){
  
  number_of_genes = length(cpg_vector) # count number of genes
  
  # filter to only target gene
  for (i in 1:length(cpg_vector)){
    raw = df_unnormalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"]) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter == "B" | SampleAnnotation$subjectLetter == "D"])
    sesame = df_normalized %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"]) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter == "B" | SampleAnnotation$subjectLetter == "D"])
    sesame_combat = df_normalized_with_combat %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"]) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter == "B" | SampleAnnotation$subjectLetter == "D"])
    sesame_combatFI_seq = ComBatFI_seq_betas %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$dvera_groundTruth!="oob"]) %>%
      select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter == "B" | SampleAnnotation$subjectLetter == "D"])

    # Add columns for each dataset that detected the CpG
    
    each_gene = data.frame(sample = colnames(raw),
      raw_betas = as.numeric(raw[1,])) # should always be there
    
    # Add other dfs (might not be there depending on filtering)
    if (length(sesame > 0)){
      each_gene$sesame_betas = as.numeric(sesame[1,])
    }
    
    if (length(sesame_combat > 0)){
      each_gene$sesame_combat_betas = as.numeric(sesame_combat[1,])
    }

    if (length(sesame_combatFI_seq > 0)){
      each_gene$sesame_combatFI_seq_betas = as.numeric(sesame_combatFI_seq[1,])
    }
    
    # each_gene2 = each_gene
    # graphic = ggpubr::ggpaired(each_gene2, cond1 = "raw_betas", cond2 = "sesame_betas", 
    #                            #fill = "condition",
    #                            color = "condition",
    #                            line.color = "grey50") + 
    #   scale_color_brewer(type = "qual", palette = 6)
    

    #plot(graphic)

    melted_data = reshape2::melt(each_gene)
    
    
    samples_by_subject = c()
    for (j in 1:length(melted_data$sample)){
      samples_by_subject[j] =  SampleAnnotation$subjectLetter[SampleAnnotation$XChipID == melted_data$sample[j]]
    }
    melted_data$subject = as.factor(samples_by_subject)

    # graph <- ggplot(melted_data, aes(x = variable, y = value, colour = variable)) +
    #   geom_jitter(size = 1, alpha = 0.5, width = 0.25) + 
    #   geom_line() + 
    #   theme_bw() + 
    #   ggtitle(as.character(cpg_vector[i]))
    # plot(graph)
    
    # testgraph = melted_data %>%
    #   filter(variable %in% c("raw_betas", "sesame_betas","sesame_combat_betas")) %>%
    #   ggpubr::ggpaired(melted_data, 
    #                              x = "variable", 
    #                              y = "value",
    #                    id = "sample",
    #                    color = "subject",
    #                    line.color="subject")
    # plot(testgraph)
    title_string = paste0(as.character(cpg_vector[i]), " - ComBat_FI")
    #print(i)
    
    testgraph_combat = melted_data %>%
      filter(variable %in% c("raw_betas", "sesame_betas","sesame_combat_betas")) %>%
      ggplot(aes(variable,value, color=subject)) +
        geom_point(aes(color = subject), alpha = 0.5)+ 
        geom_line(aes(group=sample), alpha = 0.5) +
            ylab("beta value")+
      xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(title_string, " - ComBat_betas")) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
    
    testgraph_combatFI = melted_data %>%
      filter(variable %in% c("raw_betas", "sesame_betas","sesame_combatFI_seq_betas")) %>%
      ggplot(aes(variable,value, color=subject)) +
        geom_point(aes(color = subject), alpha = 0.5)+ 
        geom_line(aes(group=sample), alpha = 0.5) +
        theme_bw() +
      ylab("beta value")+
      xlab("")+
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(title_string) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
      
      plot(testgraph_combat | 
           testgraph_combatFI)
    

    
    
  }
  
}
temp = plot_all_betas(false_positive_all_pipelines$cpgs[1:3])

```
### only raw
```{r}
plot_all_betas(false_positive_raw_only$cpgs[1:20])

```


### most sig raw Cpgs

```{r}
plot_all_betas(most_sig_cpgs_raw)
```

### most sig sesame Cpgs

```{r}
plot_all_betas(most_sig_cpgs_sesame)
```

### most sig sesame_combatBetas Cpgs

```{r}
plot_all_betas(most_sig_cpgs_sesameCombatBetas)
```

### most sig combatFI Cpgs

```{r}
plot_all_betas(most_sig_cpgs_sesameCombatFI)
```

### most sig false positive
```{r}
#false_positive_raw_only

# raw
betas_rownames = rownames(dmp_unnormalized_categorical)
data_from_hits_raw = which(betas_rownames %in% false_positive_raw_only$cpgs)
data_from_hits_raw = dmp_unnormalized_categorical[data_from_hits_raw,]
plot_all_betas(rownames(data_from_hits_raw)[1:10])

```

```{r}
# sesame
betas_rownames = rownames(dmp_unnormalized_categorical)
data_from_hits_raw = which(betas_rownames %in% false_positive_all_pipelines$cpgs)
data_from_hits_raw = dmp_unnormalized_categorical[data_from_hits_raw,]



```




## true positive

```{r}

upset_dv_combined2 = readRDS("upset_dv_combined2.Rds")
library(dplyr)
comparisons_sig = upset_dv_combined2 %>%
  filter(dmp_unnormalized_categorical_padj == TRUE) %>%
  group_by(cpgs) %>%
  summarize(comparison = list(comparison))

# none
true_positive_all = upset_dv_combined2 %>%
  filter(comparison == "BP2456vsDP2456" | comparison == "BP1378vsDP1378") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == TRUE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

true_positive_onlyUnnorm = upset_dv_combined2 %>%
  filter(comparison == "BP2456vsDP2456" | comparison == "BP1378vsDP1378") %>%
  filter(dmp_ComBatSeqFI_padj == FALSE) %>%
  filter(dmp_normalized_combat1_categorical_padj == FALSE) %>%
  filter(dmp_sesame_categorical_padj == FALSE) %>%
  filter(dmp_unnormalized_categorical_padj == TRUE)

true_positive_onlyCombat = upset_dv_combined2 %>%
  filter(comparison == "BP2456vsDP2456" | comparison == "BP1378vsDP1378") %>%
  filter(dmp_ComBatSeqFI_padj == TRUE) %>%
  filter(dmp_normalized_combat1_categorical_padj == TRUE) %>%
  filter(dmp_sesame_categorical_padj == FALSE) %>%
  filter(dmp_unnormalized_categorical_padj == FALSE)
 
```

### plotting beta values

### true_positive_all

```{r}
plot_all_betas(true_positive_all$cpgs[1:10])
```

### true_positive_onlyUnnorm

```{r}
plot_all_betas(true_positive_onlyUnnorm$cpgs[1:10])
```

### true_positive_onlyCombat

```{r}
plot_all_betas(true_positive_onlyCombat)
```


### most sig false positive
```{r}
#false_positive_raw_only

# raw
betas_rownames = rownames(dmp_unnormalized_categorical)
data_from_hits_raw = which(betas_rownames %in% false_positive_raw_only$cpgs)
data_from_hits_raw = dmp_unnormalized_categorical[data_from_hits_raw,]
plot_all_betas(rownames(data_from_hits_raw)[1:10])

```

```{r}
# sesame
betas_rownames = rownames(dmp_unnormalized_categorical)
data_from_hits_raw = which(betas_rownames %in% false_positive_all_pipelines$cpgs)
data_from_hits_raw = dmp_unnormalized_categorical[data_from_hits_raw,]



```




# plot pvalues changing
```{r}

rename_cols_and_aggregate = function(list_of_dfs){
  for (i in 1:length(list_of_dfs)){
    old_colnames = colnames(list_of_dfs[[i]])
    add_to_colname = names(list_of_dfs[i])
    new_colnames = paste0(old_colnames,"_",add_to_colname)
    colnames(list_of_dfs[[i]]) = new_colnames
  }
  for (i in 1:length(list_of_dfs)){
   if (i == 1){
     df_cbind = list_of_dfs[[i]]
   }
    else {df_cbind = merge(df_cbind,list_of_dfs[[i]],by = 'row.names')
    rownames(df_cbind) = df_cbind$Row.names
    df_cbind$Row.names = NULL}
  }
  return(df_cbind)
}

list_of_dfs = list(raw = dmp_unnormalized_categorical,
           sesame = dmp_sesame_categorical,
           combat = dmp_normalized_combat1_categorical,
           combatFI = dmp_ComBatSeqFI)
# test = rename_cols_and_aggregate(list_of_dfs)

# plot_p_values = function(list_of_dfs){
#   aggregated_dfs = rename_cols_and_aggregate(list_of_dfs)
#   plot = aggregated_dfs %>%
#     select(starts_with("p_values_corrected_")) %>%
#     reshape2::melt() %>%
#     filter(value < 0.0005) %>%
#     ggplot(aes(variable,value)) +
#         geom_point(alpha = 0.5)+ 
#         geom_line( alpha = 0.5) +
#             ylab("beta value")+
#       xlab("")+
#         theme_bw() +
#         paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
#         ggtitle(paste0( " - ComBat_betas")) +
#         theme(text = element_text(size = 5),
#               legend.position = "fdr")
#   return(plot)
# }

plot_p_values = function(list_of_dfs,dmp_cpgs){
  
  aggregated_dfs = rename_cols_and_aggregate(list_of_dfs)
  
  if (length(dmp_cpgs) >= 1000){
  aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    slice_sample(n = 500) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.1) +
            ylab("beta value")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)
  }
  
  else {aggregated_dfs = aggregated_dfs %>%
    select(starts_with("p_values_corrected_")) %>%
    filter(rownames(.) %in% dmp_cpgs) %>%
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot = ggplot(aggregated_dfs,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.1) +
            ylab("beta value")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle(paste0(deparse(substitute(dmp_cpgs)))) +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  plot(plot)}
}

#test = plot_p_values(list_of_dfs,dmp_cpgs)
#test = plot_p_values(list_of_dfs,dmps_everything)


upset_df_to_plotted_p_values = function(list_of_dfs,upset_df){
  # comparisons:
  
  
  
  
  
  library(stringr)
  
  ## only unnormalized:
  
  dmps_raw_only = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
  plot_p_values(list_of_dfs,dmps_raw_only)

  ## only sesame:
  
  dmps_sesame_only = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_sesame_only)

  
  ## only after combat
  
  dmps_after_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combat)

  
## only after combatFI
  
  dmps_after_combatFI = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_combatFI)

  
## only after sesame
  
  dmps_after_sesame_including_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_after_sesame_including_combat)

  
## everything
  
  dmps_everything = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    plot_p_values(list_of_dfs,dmps_everything)

  
}

#upset_df_to_plotted_p_values(upset_df_dv1)



```

#### dv comparisons
```{r}
ups_dv1 = upset_df_to_plotted_p_values(list_of_dfs_dv1,upset_df_dv1)
```


```{r}
ups_dv2 = upset_df_to_plotted_p_values(list_of_dfs_dv2,upset_df_dv2)
```


```{r}
ups_dv3 = upset_df_to_plotted_p_values(list_of_dfs_dv3,upset_df_dv3)
```


```{r}
ups_dv4 = upset_df_to_plotted_p_values(list_of_dfs_dv4,upset_df_dv4)
```

#### ab comparisons
```{r}
ups_ab1 = upset_df_to_plotted_p_values(list_of_dfs_ab1,upset_df_ab1)
```


```{r}
ups_ab2 = upset_df_to_plotted_p_values(list_of_dfs_ab2,upset_df_ab2)
```


```{r}
ups_ab3 = upset_df_to_plotted_p_values(list_of_dfs_ab3,upset_df_ab3)
```


```{r}
ups_ab4 = upset_df_to_plotted_p_values(list_of_dfs_ab4,upset_df_ab4)
```


```{r}
ups_ab5 = upset_df_to_plotted_p_values(list_of_dfs_ab5,upset_df_ab5)
```


```{r}
ups_ab6 = upset_df_to_plotted_p_values(list_of_dfs_ab6,upset_df_ab6)
```


```{r}
ups_ab7 = upset_df_to_plotted_p_values(list_of_dfs_ab7,upset_df_ab7)
```


```{r}
ups_ab8 = upset_df_to_plotted_p_values(list_of_dfs_ab8,upset_df_ab8)
```


# upset_df_to_plotted_p_beta_andStdevRatio

This only really makes sense for target cpgs, because so many different beta values for each. Maybe average beta value would be okay though

#### SAVED STATE HERE

```{r}
# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)
betas_list = list(raw = df_unnormalized,
                  sesame = df_normalized,
                  combatBetas = df_normalized_with_combat,
                  combatFI = ComBatFI_seq_betas)


betas_list_merged = rename_cols_and_aggregate(betas_list)



# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL)

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL)

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject b
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject d
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

  
stdevB_to_stdevAll = stdev_b / stdev_all
rownames(stdevB_to_stdevAll)= rownames(betas_list_merged)

stdevD_to_stdevAll = stdev_d / stdev_all
rownames(stdevD_to_stdevAll) = rownames(betas_list_merged)

```

betas

```{r}



plot_only_comparisons_betas = function(included_sample_vector,cpg_vector){
  
  number_of_genes = length(cpg_vector) # count number of genes

  # filter to only target gene
  for (i in 1:number_of_genes){
    raw = df_unnormalized %>%
      select(any_of(included_sample_vector)) %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame = df_normalized %>%
      select(any_of(included_sample_vector)) %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame_combat = df_normalized_with_combat %>%
      select(any_of(included_sample_vector)) %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)
    sesame_combatFI_seq = ComBatFI_seq_betas %>%
      select(any_of(included_sample_vector)) %>%
      make_cpgs() %>%
      filter(cpgs %in% cpg_vector[i]) %>%
      select(-cpgs)

    # Add columns for each dataset that detected the CpG
    
    each_gene = data.frame(sample = colnames(raw),
      raw_betas = as.numeric(raw[1,])) # should always be there
    
    # Add other dfs (might not be there depending on filtering)
    if (length(sesame > 0)){
      each_gene$sesame_betas = as.numeric(sesame[1,])
    }
    
    if (length(sesame_combat > 0)){
      each_gene$sesame_combat_betas = as.numeric(sesame_combat[1,])
    }

    if (length(sesame_combatFI_seq > 0)){
      each_gene$sesame_combatFI_seq_betas = as.numeric(sesame_combatFI_seq[1,])
    }

    melted_data = reshape2::melt(each_gene)
    
    samples_by_subject = c()
    for (i in 1:length(melted_data$sample)){
      samples_by_subject[i] =  SampleAnnotation$subjectLetter[SampleAnnotation$XChipID == melted_data$sample[i]]
    }
    melted_data$subject = as.factor(samples_by_subject)

    graph <- ggplot(melted_data, aes(x = variable, y = value, colour = variable)) +
      #geom_boxplot(notch = TRUE) +
      geom_jitter(size = 1, alpha = 0.5, width = 0.25, aes(colour = subject)) +
      theme_bw() + 
      ggtitle(cpg_vector[i])
    plot(graph)
  }
  
}

my_comparisons = SampleAnnotation %>%
  filter(dvera_groundTruthForPlotting == "dv1") %>%
  pull(XChipID)

plot_only_comparisons_betas(included_sample_vector = my_comparisons,
                            cpg_vector = false_positive_all_pipelines$cpgs[1:3]
                            )


```

### plot_single_stdevratio
```{r}
library(patchwork)
plot_single_stdevratio = function(cpgs){
  if (length(cpgs)>500){
    cpgs = sample(cpgs,500, replace = FALSE)
  }
  sd_df_d = stdevD_to_stdevAll %>%
    filter(rownames(.) %in% cpgs) %>% 
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot_d = ggplot(sd_df_d,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.1) +
            ylab("stdev ratio (within-subject / between-subjects)")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle("Subject D") +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  
    sd_df_b = stdevB_to_stdevAll %>%
    filter(rownames(.) %in% cpgs) %>% 
    mutate(cpg = rownames(.)) %>%
    reshape2::melt(ids = cpg)
  plot_b = ggplot(sd_df_b,aes(variable,value)) +
        geom_point(alpha = 0.01) + 
        geom_line(aes(group = cpg),alpha = 0.1) +
            ylab("stdev ratio (within-subject / between-subjects)")+
        xlab("")+
        theme_bw() +
        paletteer::scale_color_paletteer_d(palette = "ggsci::alternating_igv") +
        ggtitle("Subject B") +
        theme(text = element_text(size = 5),
              legend.position = "fdr")
  
  return(plot(plot_b | plot_d))
}

cpgs = rownames(betas_list_merged)[1:10]
plot_single_stdevratio(cpgs)

```




```{r}
# function to make plots for the given cpgs:

upset_df_to_plotted_p_beta_andStdevRatio = function(list_of_dfs,upset_df,included_sample_vector){


  
  
  
  
  library(stringr)
  
  ## only unnormalized:
  
  dmps_raw_only = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
  p_rawOnly = plot_p_values(list_of_dfs,dmps_raw_only)
  sd_rawOnly = plot_single_stdevratio(dmps_raw_only)
  #plot_only_comparisons_betas(included_sample_vector,dmps_raw_only[1:10])

  ## only sesame:
  
  dmps_sesame_only = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    p_sesameOnly = plot_p_values(list_of_dfs,dmps_sesame_only)
    sd_sesameOnly = plot_single_stdevratio(dmps_sesame_only)
    #plot_only_comparisons_betas(included_sample_vector,dmps_sesame_only[1:10])

  
  ## only after combat betas
  
  dmps_after_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    p_combatBetaOnly = plot_p_values(list_of_dfs,dmps_after_combat)
    sd_combatBetaOnly =plot_single_stdevratio(dmps_after_combat)
    #plot_only_comparisons_betas(included_sample_vector,dmps_after_combat[1:10])

  
## only after combatFI
  
  dmps_after_combatFI = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(!str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(!str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    p_combatFI_only = plot_p_values(list_of_dfs,dmps_after_combatFI)
    sd_combatFI_only = plot_single_stdevratio(dmps_after_combatFI)
    #plot_only_comparisons_betas(included_sample_vector,dmps_after_combatFI[1:10])

  
## only after sesame
  
  dmps_after_sesame_including_combat = upset_df %>%
    filter(!str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    p_all_preprocessed = plot_p_values(list_of_dfs,dmps_after_sesame_including_combat)
    sd_all_preprocessed =plot_single_stdevratio(dmps_after_sesame_including_combat)
    #plot_only_comparisons_betas(included_sample_vector,dmps_after_sesame_including_combat[1:10])


  
## everything
  
  dmps_everything = upset_df %>%
    filter(str_detect(variable, "dmp_unnormalized_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_ComBatSeqFI_padj")) %>%
    filter(str_detect(variable, "dmp_sesame_categorical_padj")) %>%
    filter(str_detect(variable, "dmp_normalized_combat1_categorical_padj")) %>%
    pull(cpgs)
    p_alwaysPositive = plot_p_values(list_of_dfs,dmps_everything)
    sd_alwaysPositive = plot_single_stdevratio(dmps_everything)
    #plot_only_comparisons_betas(included_sample_vector,dmps_everything[1:10])

    p_values_plot = (p_rawOnly / p_sesameOnly / p_combatBetaOnly / p_combatFI_only)
    
    
    sd_plot = (sd_rawOnly / sd_sesameOnly / sd_combatBetaOnly / sd_combatFI_only)
    final_plot = (p_values_plot | sd_plot) 
  
    plot(final_plot)
}



```

# all dv1 plots
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)

my_comparisons = SampleAnnotation %>%
  filter(dvera_groundTruthForPlotting == "dv1") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs_dv1,upset_df_dv1,included_sample_vector = my_comparisons)


make_stdevRatio_boxplots(my_comparisons)

```




# bookmark to test make_stdevRatio
```{r}
make_stdevRatio_boxplots_bOnly = function(list_of_samples){
# needs these dataframes in the env
betas_list = list(raw = df_unnormalized,
                sesame = df_normalized,
                combatBetas = df_normalized_with_combat,
                combatFI = ComBatFI_seq_betas)
# also this function
betas_list_merged = rename_cols_and_aggregate(betas_list)


# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)






# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# for subject b
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
  select(any_of(list_of_samples))

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# # for subject d
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# # for subject a
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_a = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# # for subject c
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_c = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# 



# stdevA_to_stdevAll = stdev_a / (stdev_all+0.0001)
# rownames(stdevA_to_stdevAll)= rownames(betas_list_merged)

stdevB_to_stdevAll = stdev_b / (stdev_all+0.0001)
rownames(stdevB_to_stdevAll)= rownames(betas_list_merged)

# stdevC_to_stdevAll = stdev_c / (stdev_all+0.0001)
# rownames(stdevC_to_stdevAll)= rownames(betas_list_merged)

# stdevD_to_stdevAll = stdev_d / (stdev_all+0.0001)
# rownames(stdevD_to_stdevAll) = rownames(betas_list_merged)


stdevRatio_raw = data.frame(#a = stdevA_to_stdevAll$raw_stdev,
                           b = stdevB_to_stdevAll$raw_stdev
                           #c = stdevC_to_stdevAll$raw_stdev,
                           #d = stdevD_to_stdevAll$raw_stdev
                           )
stdevRatio_sesame = data.frame(#a = stdevA_to_stdevAll$sesame_stdev,
                           b = stdevB_to_stdevAll$sesame_stdev
                           #c = stdevC_to_stdevAll$sesame_stdev,
                           #d = stdevD_to_stdevAll$sesame_stdev
                           )
stdevRatio_combatBeta = data.frame(#a = stdevA_to_stdevAll$combatBeta_stdev,
                           b = stdevB_to_stdevAll$combatBeta_stdev
                           #c = stdevC_to_stdevAll$combatBeta_stdev,
                           #d = stdevD_to_stdevAll$combatBeta_stdev
                           )
stdevRatio_combatFI = data.frame(#a = stdevA_to_stdevAll$combatFI_stdev,
                           b = stdevB_to_stdevAll$combatFI_stdev
                           #c = stdevC_to_stdevAll$combatFI_stdev,
                           #d = stdevD_to_stdevAll$combatFI_stdev
                           )
averages_stdev_ratio = data.frame(raw = apply(stdevRatio_raw,1,mean),
                                  sesame = apply(stdevRatio_sesame,1,mean),
                                  combatBeta = apply(stdevRatio_combatBeta,1,mean),
                                  combatFI = apply(stdevRatio_combatFI,1,mean)
                                  )




rownames(averages_stdev_ratio) = rownames(stdevB_to_stdevAll)

averages_stdev_ratio = reshape2::melt(averages_stdev_ratio)

graph_global_stdev_ratios <- ggplot(averages_stdev_ratio, aes(x = variable, y = value)) +
  geom_boxplot(notch = FALSE) +
  theme_bw() + 
  ggtitle("stdev ratios across all samples")
graph_global_stdev_ratios
}

make_stdevRatio_boxplots_dOnly = function(list_of_samples){
# needs these dataframes in the env
betas_list = list(raw = df_unnormalized,
                sesame = df_normalized,
                combatBetas = df_normalized_with_combat,
                combatFI = ComBatFI_seq_betas)
# also this function
betas_list_merged = rename_cols_and_aggregate(betas_list)


# Stdev ratio needed for each CpG (stdev within sample / stdev between samples)






# filter to common cpgs
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>% 
  select(any_of(list_of_samples))

# calculate stdevs for all samples
raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_all = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# # for subject b
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="B"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_b = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# for subject d
raw_betas = df_unnormalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged)) %>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>%
  select(any_of(list_of_samples))

sesame_betas = df_normalized %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>%
  select(any_of(list_of_samples))

combatBeta_betas = df_normalized_with_combat %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>%
  select(any_of(list_of_samples))

combatFI_betas = ComBatFI_seq_betas %>%
  mutate(cpg = rownames(.)) %>%
  filter(cpg %in% rownames(betas_list_merged))%>%
  mutate(cpg = NULL) %>%
  select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="D"])%>%
  select(any_of(list_of_samples))

raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)

stdev_d = data.frame(#cpgs = rownames(betas_list_merged),
                       raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
                       sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
                       combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))

# # for subject a
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="A"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_a = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# # for subject c
# raw_betas = df_unnormalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged)) %>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# sesame_betas = df_normalized %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatBeta_betas = df_normalized_with_combat %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# combatFI_betas = ComBatFI_seq_betas %>%
#   mutate(cpg = rownames(.)) %>%
#   filter(cpg %in% rownames(betas_list_merged))%>%
#   mutate(cpg = NULL) %>%
#   select(SampleAnnotation$XChipID[SampleAnnotation$subjectLetter=="C"])%>% 
#   select(any_of(list_of_samples))
# 
# raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE)
# sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE)
# combatFI_stdev = apply(ComBatFI_seq_betas, MARGIN = 1,sd, na.rm=TRUE)
# 
# stdev_c = data.frame(#cpgs = rownames(betas_list_merged),
#                        raw_stdev = apply(raw_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        sesame_stdev = apply(sesame_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatBeta_stdev = apply(combatBeta_betas, MARGIN = 1,sd, na.rm=TRUE),
#                        combatFI_stdev = apply(combatFI_betas, MARGIN = 1,sd, na.rm=TRUE))
# 
# 



# stdevA_to_stdevAll = stdev_a / (stdev_all+0.0001)
# rownames(stdevA_to_stdevAll)= rownames(betas_list_merged)

# stdevB_to_stdevAll = stdev_b / (stdev_all+0.0001)
# rownames(stdevB_to_stdevAll)= rownames(betas_list_merged)

# stdevC_to_stdevAll = stdev_c / (stdev_all+0.0001)
# rownames(stdevC_to_stdevAll)= rownames(betas_list_merged)

stdevD_to_stdevAll = stdev_d / (stdev_all+0.0001)
rownames(stdevD_to_stdevAll) = rownames(betas_list_merged)


stdevRatio_raw = data.frame(#a = stdevA_to_stdevAll$raw_stdev,
                           #b = stdevB_to_stdevAll$raw_stdev
                           #c = stdevC_to_stdevAll$raw_stdev,
                           d = stdevD_to_stdevAll$raw_stdev
                           )
stdevRatio_sesame = data.frame(#a = stdevA_to_stdevAll$sesame_stdev,
                           #b = stdevB_to_stdevAll$sesame_stdev
                           #c = stdevC_to_stdevAll$sesame_stdev,
                           d = stdevD_to_stdevAll$sesame_stdev
                           )
stdevRatio_combatBeta = data.frame(#a = stdevA_to_stdevAll$combatBeta_stdev,
                           #b = stdevB_to_stdevAll$combatBeta_stdev
                           #c = stdevC_to_stdevAll$combatBeta_stdev,
                           d = stdevD_to_stdevAll$combatBeta_stdev
                           )
stdevRatio_combatFI = data.frame(#a = stdevA_to_stdevAll$combatFI_stdev,
                           #b = stdevB_to_stdevAll$combatFI_stdev
                           #c = stdevC_to_stdevAll$combatFI_stdev,
                           d = stdevD_to_stdevAll$combatFI_stdev
                           )
averages_stdev_ratio = data.frame(raw = apply(stdevRatio_raw,1,mean),
                                  sesame = apply(stdevRatio_sesame,1,mean),
                                  combatBeta = apply(stdevRatio_combatBeta,1,mean),
                                  combatFI = apply(stdevRatio_combatFI,1,mean)
                                  )




rownames(averages_stdev_ratio) = rownames(stdevB_to_stdevAll)

averages_stdev_ratio = reshape2::melt(averages_stdev_ratio)

graph_global_stdev_ratios <- ggplot(averages_stdev_ratio, aes(x = variable, y = value)) +
  geom_boxplot(notch = FALSE) +
  theme_bw() + 
  ggtitle("stdev ratios across all samples")
graph_global_stdev_ratios
}
```


```{r}
my_comparisons = SampleAnnotation %>%
  filter(dvera_groundTruthForPlotting == "dv2") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_dv2,
                                         upset_df = upset_df_dv2,
                                         included_sample_vector = my_comparisons)

make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(dvera_groundTruthForPlotting == "dv3") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_dv3,
                                         upset_df = upset_df_dv3,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}




my_comparisons = SampleAnnotation %>%
  filter(dvera_groundTruthForPlotting == "dv4") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_dv4,
                                         upset_df = upset_df_dv4,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting == "ab1") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab1,
                                         upset_df = upset_df_ab1,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting == "ab2") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab2,
                                         upset_df = upset_df_ab2,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting == "ab3") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab3,
                                         upset_df = upset_df_ab3,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)








```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting == "ab4") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab4,
                                         upset_df = upset_df_ab4,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting2 == "ab5") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab5,
                                         upset_df = upset_df_ab5,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting2 == "ab6") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab6,
                                         upset_df = upset_df_ab6,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting2 == "ab7") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab7,
                                         upset_df = upset_df_ab7,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```

```{r}
my_comparisons = SampleAnnotation %>%
  filter(abutler_groundTruthForPlotting2 == "ab8") %>%
  pull(XChipID)
upset_df_to_plotted_p_beta_andStdevRatio(list_of_dfs = list_of_dfs_ab8,
                                         upset_df = upset_df_ab8,
                                         included_sample_vector = my_comparisons)
make_stdevRatio_boxplots(my_comparisons)
```



# Final figure for figure 3
```{r}
library(patchwork)

Figure3_left = (wrap_elements(grid::textGrob('Tube graphics: ')) + wrap_elements(grid::textGrob('Tube graphics2: ')) + graph_global_stdev_ratios)  +
  (fig_differential_methylation_BH_pValues_dv1 + fig_differential_methylation_BH_pValues_ab1 + fig_differential_methylation_BH_pValues_ab2 ) +
  (fig_differential_methylation_BH_pValues_dv4 + fig_differential_methylation_BH_pValues_ab3 + fig_differential_methylation_BH_pValues_ab4) + 
  plot_annotation(tag_levels = 'a')

Figure3_left



Figure3_left = (
(wrap_elements(grid::textGrob('Tube graphics: ')) | wrap_elements(grid::textGrob('Tube graphics2: ')) | graph_global_stdev_ratios)  /
  (fig_differential_methylation_BH_pValues_dv1 | fig_differential_methylation_BH_pValues_ab1 | fig_differential_methylation_BH_pValues_ab2 ) /
  (fig_differential_methylation_BH_pValues_dv4 | fig_differential_methylation_BH_pValues_ab3 | fig_differential_methylation_BH_pValues_ab4)
)
Figure3_left
  
Figure3_right = (positive_raw /
positive_sesame /
positive_sesameCombat /
positive_sesameCombatSeqFI 
)

### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "Fig3_left_draft.pdf"),   # The directory you want to save the file in
    width = (140/25.4), # The width of the plot in inches (converted from mm)
    height = (140/25.4)) # The height of the plot in inches
Figure3_left
dev.off()
###

### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "Fig3_right_draft_11092023.pdf"),   # The directory you want to save the file in
    width = (90/25.4), # The width of the plot in inches (converted from mm)
    height = (180/25.4)) # The height of the plot in inches
Figure3_right
dev.off()
###

```








```{r}
library(patchwork)
library(ggplot2)
library(ggupset)

graph_global_stdev_ratios_final = graph_global_stdev_ratios + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1),text = element_text(size = 6)) +
  labs(y = "stdev ratios", x = "")
graph_global_stdev_ratios
graph_global_stdev_ratios_final

upset_gg_BN1234andDN1234vsBN5678andDN5678_final = upset_gg_BN1234andDN1234vsBN5678andDN5678 + 
  theme(text = element_text(size = 6)) +
  theme_combmatrix(combmatrix.label.text = element_text(size=5))


design_fig3 = 
"AABC
VVVV
TUUU
DEFG
HIJK
LMNO
PQRS"

Fig3_combined = (graph_global_stdev_ratios_final + wrap_elements(grid::textGrob('')) + upset_gg_BN1234andDN1234vsBN5678andDN5678_final +
graph1_dv4 + graph1_dv1 + positive_raw + graph1_8v8 +
  graph2_dv4 + graph2_dv1 + positive_sesame + graph2_8v8 +
  graph3_dv4 + graph3_dv1 + positive_sesameCombat + graph3_8v8 +
  graph6_dv4 + graph6_dv1 + positive_sesameCombatSeqFI + graph6_8v8 + wrap_elements(grid::textGrob('')) + wrap_elements(grid::textGrob('')) +
  wrap_elements(grid::textGrob('')) +
                  plot_layout(design = design_fig3) +
  plot_annotation(tag_levels = 'a'))
Fig3_combined

### Plotting
pdf_export_directory = '~/dnamstability/dnamstability-abutler/pdf_plots/' #where I'm saving figures
pdf(file = paste0(pdf_export_directory, "Fig3_combined_09252023.pdf"),   # The directory you want to save the file in
    width = (183/25.4), # The width of the plot in inches (converted from mm)
    height = (225/25.4)) # The height of the plot in inches
Fig3_combined
dev.off()


```

























